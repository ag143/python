## Developing commercial projects with Django

> **Description**: Some of the illustrations in this article come from "Python Project Development" and "Mastering Django", both of which contain wonderful explanations of the Django framework, and interested readers can purchase and read by themselves.

### Web Application

Question 1: Describe the workflow of a web application.

![](./res/web-application.png)

Question 2: Describe the physical architecture of the project. (The above figure supplements load balancing (reverse proxy) servers, database servers, file servers, mail servers, cache servers, firewalls, etc., and each node may be a multi-node cluster. Of course, the architecture is based on business It needs to evolve step by step rather than overnight.)

Question 3: Describe the workflow of a Django project. (As shown below)

![](./res/django_request_response_cycle.png)

### MVC Architecture Pattern

Question 1: Why use the MVC architectural pattern? (model and view decoupling)

Question 2: The role of each part in the MVC architecture? (As shown below)

![](./res/mvc.png)

### HTTP requests and responses

#### HTTP request = request line + request header + blank line + [message body]

![](./res/http-request.png)

#### HTTP response = response line + response header + blank line + message body

![](./res/http-response.png)

1. Properties and methods of the `HTTPRequest` object:

   - `method` - get the request method
   - `path` / `get_full_path()` - get request path/path with query string
   - `scheme` / `is_secure()` / `get_host()` / `get_port()` - get the requested protocol/host/port
   - `META` / `COOKIES` - get request header/cookie information
   - `GET` / `POST` / `FILES` - get GET or POST request parameters/uploaded files
   - `get_signed_cookie()` - get signed cookie
   - `is_ajax()` - is not an Ajax asynchronous request
   - `body` / `content_type` / `encoding` - get the requested message body (bytes stream)/MIME type/encoding
2. Properties added by the middleware:

   - `session` / `user` / `site`
3. Properties and methods of the `HttpResponse` object:

   - `set_cookie()` / `set_signed_cookie()` / `delete_cookie()` - add/delete cookies
   - `__setitem__` / `__getitem__` / `__delitem__` - add/get/delete response headers
   - `charset` / `content` / `status_code` - response charset/message body (bytes stream)/status code
     - 1xx: The request has been received, continue processing
     - 2xx (success): The request has been successfully received, understood and received.
     - 3xx (redirect): To complete the request to continue to perform subsequent operations.
     - 4xx (Client Error): The request is incorrect or cannot be processed.
     - 5xx (Server Error): The server failed to process the request.
4. `JsonResponse` (subtype of `HttpResponse`) object

    ````Python
    >>> from django.http import HttpResponse, JsonResponse
    >>>
    >>> response = JsonResponse({'foo': 'bar'})
    >>> response.content
    >>>
    >>> response = JsonResponse([1, 2, 3], safe=False)
    >>> response.content
    >>>
    >>> response = HttpResponse(b'...')
    >>> response['cotent-type'] = 'application/pdf';
    >>> response['content-disposition'] = 'inline; filename="xyz.pdf"'
    >>> response['content-disposition'] = 'attachment; filename="xyz.pdf"'
    >>>
    >>> response.set_signed_cookie('foo', 'bar', salt='')
    >>> response.status_code = 200
    ````

### Data Model (Model)

Question 1: What issues should be paid attention to in the design of relational database tables (paradigm theory and inverse paradigm)? How to create a model class (reverse engineer) from a table? How to create tables from model classes (forward engineering)?

```Shell
python manage.py makemigrations <appname>
python manage.py migrate

python manage.py inspectdb > <appname>/models.py
````

Question 2: What is meant by data integrity in relational databases? When do you need to sacrifice data integrity? (Entity Integrity / Referential Integrity / Domain Integrity)

Question 3: What is an ORM and what problem does it solve? (Object model-relational model bidirectional conversion)

1. Attributes of `Field` and its subclasses:

   - General options:
     - `db_column` / `db_tablespace`
     - `null` / `blank` / `default`
     - `primary_key`
     - `db_index` / `unqiue`
     - `choices` / `help_text` / `error_message` / `editable` / `hidden`
   - other options:
     - `CharField`: `max_length`
     - `DateField`: `auto_now` / `auto_now_add`
     - `DecimalField`: `max_digits` / `decimal_places`
     - `FileField`: `storage` / `upload_to`
     - `ImageField`: `height_field` / `width_field`

2. Properties of `ForeignKey`:

   - Important attributes:
     - `db_constraint` (may need to be set to `False` to improve performance or data fragmentation)

     - `on_delete`

       * `CASCADE`: Cascade delete.

       - `PROTECT`: Throws a `ProtectedError` exception, preventing deletion of the referenced object.
       - `SET_NULL`: Set the foreign key to `null`, which can only be done when the `null` property is set to `True`.
       - `SET_DEFAULT`: Set the foreign key to the default value, which can only be done by providing a default value.

     - `related_name`

       ````Python
       class Dept(models.Model):
           pass
       
       
       class Emp(models.Model):
           dept = models.ForeignKey(related_name='+', ...)
           
        
       Dept.objects.get(no=10).emp_set.all()
       Emp.objects.filter(dept__no=10)
       ````

       > Description: `related_name` is set to `'+'`, which can prevent one-to-many foreign key association from querying the "many" side from the "one" side.

   - Other properties:

     - `to_field` / `limit_choices_to` / `swappable`

3. `Model` properties and methods

   - `objects` / `pk`

   - `save()` / `delete()`

   - `clean()` / `validate_unique()` / `full_clean()`

4. Methods of `QuerySet`

   - `get()` / `all()` / `values()`

     > Description: The `QuerySet` returned by `values()` is not a model object but a dictionary

   - `count()` / `order_by()` / `exists()` / `reverse()`

   - `filter()` / `exclude()`

     - `exact` / `iexact`: exact match/case-ignoring exact match query
     - `contains` / `icontains` / `startswith / istartswith / endswith / iendswith`: fuzzy query based on `like`
     - `in`: set operation
     - `gt` / `gte` / `lt` / `lte`: greater than/greater than equal/less than/less than equal relational operations
     - `range`: Specify a range query (`between…and…` in SQL)
     - `year` / `month` / `day` / `week_day` / `hour` / `minute` / `second`: query time and date
     - `isnull`: query for null (`True`) or non-null (`False`) values
     - `search`: full-text search based on full-text indexing
     - `regex` / `iregex`: Regular expression based fuzzy matching query
     - `aggregate()` / `annotate()`

     - `Avg` / `Count` / `Sum` / `Max` / `Min`

       ````Python
       >>> from django.db.models import Avg
       >>> Emp.objects.aggregate(avg_sal=Avg('sal'))
       (0.001) SELECT AVG(`TbEmp`.`sal`) AS `avg_sal` FROM `TbEmp`; args=()
       {'avg_sal': 3521.4286}
       ````

       ````Python
       >>> Emp.objects.values('dept').annotate(total=Count('dept'))
       (0.001) SELECT `TbEmp`.`dno`, COUNT(`TbEmp`.`dno`) AS `total` FROM `TbEmp` GROUP BY `TbEmp`.`dno` ORDER BY NULL LIMIT 21; args=()
       <QuerySet [{'dept': 10, 'total': 4}, {'dept': 20, 'total': 7}, {'dept': 30, 'total': 3}]
       ````

   - `first()` / `last()`

     > Note: Calling the `first()` method is equivalent to slicing the `QuerySet` with `[0]`.

   - `only()` / `defer()`

     ````Python
     >>> Emp.objects.filter(pk=7800).only('name', 'sal')
     (0.001) SELECT `TbEmp`.`empno`, `TbEmp`.`ename`, `TbEmp`.`sal` FROM `TbEmp` WHERE `TbEmp`.`empno` = 7800 LIMIT 21; args=(7800,)
     <QuerySet [<Emp: Emp object (7800)>]>
     >>> Emp.objects.filter(pk=7800).defer('name', 'sal')
     (0.001) SELECT `TbEmp`.`empno`, `TbEmp`.`job`, `TbEmp`.`mgr`, `TbEmp`.`comm`, `TbEmp`.`dno` FROM `TbEmp` WHERE `TbEmp `.`empno` = 7800 LIMIT 21; args=(7800,)
     <QuerySet [<Emp: Emp object (7800)>]>
     ````

   - `create()` / `update()` / `raw()`

     ````Python
     >>> Emp.objects.filter(dept__no=20).update(sal=F('sal') + 100)
     (0.011) UPDATE `TbEmp` SET `sal` = (`TbEmp`.`sal` + 100) WHERE `TbEmp`.`dno` = 20; args=(100, 20)
     >>>
     >>> Emp.objects.raw('select empno, ename, job from TbEmp where dno=10')
     <RawQuerySet: select empno, ename, job from TbEmp where dno=10>
     ````

5. `Q` object and `F` object

   > Description: The Q object is mainly used to solve complex queries with multiple conditions; the F object is mainly used to update data.

   ````Python
   >>> from django.db.models import Q
   >>> Emp.objects.filter(
   ... Q(name__startswith='Zhang'),
   ...Q(sal__lte=5000) | Q(comm__gte=1000)
   ... ) # Query employees whose name starts with "Zhang" and whose salary is less than or equal to 5000 or whose subsidy is greater than or equal to 1000
   <QuerySet [<Emp: Zhang Sanfeng>]>
   ````

   ````Python
   >>> from backend.models import Emp, Dept
   >>> emps = Emp.objects.filter(dept__no=20)
   >>> from django.db.models import F
   >>> emps.update(sal=F('sal') + 100)
   ````

6. Native SQL query

   ````Python
   from django.db import connections
   
   
   with connections['...'].cursor() as cursor:
       cursor.execute("UPDATE TbEmp SET sal=sal+10 WHERE dno=30")
       cursor.execute("SELECT ename, job FROM TbEmp WHERE dno=10")
       row = cursor.fetchall()
   ````

7. Model Manager

   ````Python
   class BookManager(models.Manager):
       
       def title_count(self, keyword):
           return self.filter(title__icontains=keyword).count()
   
   class Book(models.Model):
       
       objects = BookManager()
   ````

### View function (Controller)

#### How to design view functions

1. Each request (user story) of the user corresponds to a view function. Of course, the business logic to be executed by the user can also be encapsulated into a separate function, that is, the business logic in a special module handler.

2. The user's request may contain multiple (persistent) operations, and these operations may need to be designed as indivisible atomic operations, so the boundary of the transaction is formed here.

   - ACID properties of transactions.

     - Atomicity: The operations of each item in the transaction are either done or not done at all;
     - Consistentcy: The state of the system before and after the transaction is consistent;
     - Isolation: concurrently executing transactions cannot see each other's intermediate states;
     - Duration: Changes made after the transaction is completed will be persisted.

   - Transaction isolation level - Setting the transaction isolation level is for the database bottom layer to add appropriate locks to the data according to the transaction isolation level. If you need to ensure strong data consistency, relational databases are still the only and best choice, because relational databases can protect data through locking mechanisms. The transaction isolation level from low to high is: Read Uncommitted (read uncommitted), Read Committed (read commit), Repeatable Read (repeatable read), Serializable (serialization). The higher the transaction isolation level, the fewer problems with concurrent data access, but the worse the performance; the lower the transaction isolation level, the more problems with concurrent data access, but the better the performance.

   - Concurrent data access will cause 5 kinds of questions (please refer to my ["Java Interview Questions (Part 1)"] (https://blog.csdn.net/jackfrued/article/details/44921941) question 80 for this question explanation):

     - Type 1 lost updates (A transaction undoes data updated by B transaction) and Type 2 lost updates (A transaction commits overwrites data updated by B transaction).
     - Dirty read (read dirty data): A transaction reads data to other transactions that have not yet committed.
     - Non-repeatable read: When a transaction reads its query results, its query records are updated by another transaction, so the data cannot be read.
     - Phantom read: When a transaction reads its query results, it finds that it has read new data submitted by another transaction.

     ````SQL
     -- Set the global default transaction isolation level
     set global transaction isolation level repeatable read;
     -- Set the transaction isolation level for the current session
     set session transaction isolation level read committed;
     -- Query the transaction isolation level of the current session
     select @@tx_isolation;
     ```

- Transaction control in Django.

     - Bind transaction context to each request (anti-pattern).

       ````Python
       ATOMIC_REQUESTS=True
       ````

     - Use transaction decorators (easy to use) - Coarse-grained (not fine-grained control).

       ````Python
       @transaction.non_atomic_requests
       @transaction.atomic
       ````

     - Use contextual syntax (fine grained - more precise scope of transaction control).

       ````Python
       with transaction.atomic():
           pass
       ````

     - Turn off auto-commit and use manual commit.

       ````Python
       AUTOCOMMIT=False
       ````

       ````Python
       transaction.commit()
       transaction.rollback()
       ````

#### URL configuration

1. Some URLs can only take effect in debug mode.

   ````Python
   from django.conf import settings
   
   urlpatterns = [
       ...
   ]
   
   if settings.DEBUG:
       urlpatterns += [ ... ]
   ````

2. Path parameters can be captured using named capturing groups.

   ````Python
   url(r'api/code/(?P<mobile>1[3-9]\d{9})'),
   path('api/code/<str:mobile>'),
   ````

3. The URL configuration does not care about the method used by the request (a view function can handle different request methods).

4. If the path parameters captured by the `url` function are all strings, the `path` function can specify the path parameter type.

5. You can use the `include` function to import other URL configurations and specify `namespace` to resolve naming conflicts, and the captured parameters will be passed down.

6. In the `url` and `path` functions and even the `include` function, you can use a dictionary to pass additional parameters to the view. If the parameter has the same name as the captured parameter, the parameter in the dictionary is used.

7. You can use the `reverse` function to perform reverse parsing of URLs (resolve URLs from names), and you can use `{% url %}` to achieve the same operation in templates.

   ````Python
   path('', views.index, name='index')
   
   return redirect(reverse('index'))
   return redirect('index')
   ````


### Template (View)

#### Backend rendering

1. Template configuration and rendering functions.

   ````Python
   TEMPLATES = [
       {
           'BACKEND': 'django.template.backends.django.DjangoTemplates',
           'DIRS': [os.path.join(BASE_DIR, 'templates'), ],
           'APP_DIRS': True,
           'OPTIONS': {
               'context_processors': [
                   'django.template.context_processors.debug',
                   'django.template.context_processors.request',
                   'django.contrib.auth.context_processors.auth',
                   'django.contrib.messages.context_processors.messages',
               ],
           },
       },
   ]
   ````

   ````Python
   resp = render(request, 'index.html', {'foo': ...})
   ````

2. The lookup order in which the template encounters the variable name.

   - Dictionary lookup (eg: `foo['bar']`)
   - property lookup (eg: `foo.bar`)
   - method calls (eg: `foo.bar()`)
     - Methods cannot have parameters that must be passed by value
     - You cannot pass parameters to methods in templates
     - If the `alters_data` of the method is set to `True`, the method cannot be called (to avoid the risk of misoperation), the `delete()` and `save()` methods dynamically generated by the model object both set `alters_data = True`.
   - List index lookup (eg: `foo[0]`)

3. Use of template tags.

   - `{% if %}` / `{% else %}` / `{% endif %}`
   - `{% for %}` / `{% endfor %}`
   - `{% ifequal %}` / `{% endifequal %}` / `{% ifnotequal %}` / `{% endifnotequal %}`
   - `{# comment #}` / `{% comment %}` / `{% endcomment %}`

4. Use of Filters.

   - `lower` / `upper` / `first` / `last` / `truncatewords` / `date`/ `time` / `length` / `pluralize` / `center` / `ljust` / `rjust` / ` cut` / `urlencode` / `default_if_none` / `filesizeformat` / `join` / `slice` / `slugify`

5. Template inclusion and inheritance.

   - `{% include %}` / `{% block %}`
   - `{% extends %}`

6. Template loader (will be covered in the optimization section later).

   - File system loader

     ````Python
     TEMPLATES = [{
         'BACKEND': 'django.template.backends.django.DjangoTemplates',
         'DIRS': [os.path.join(BASE_DIR, 'templates')],
     }]
     ````

   - Application directory loader

     ````Python
     TEMPLATES = [{
         'BACKEND': 'django.template.backends.django.DjangoTemplates',
         'APP_DIRS': True,
     }]
     ````


#### Front-end rendering

1. Front-end template engine: Handlebars / Mustache.
2. Front-end MV\* framework.
   - MVC - AngularJS
   - MVVM (Model-View-ViewModel) - Vue.js

#### Other Views

1. MIME (Multipurpose Internet Mail Extensions) type - tells the browser what type of data to transmit.

   | Content-Type | Description |
   | ---------------- | -------------------------------- ---------------------------- |
   | application/json | [JSON](https://en.wikipedia.org/wiki/JSON) (JavaScript Object Notation) |
   | application/pdf | [PDF](https://en.wikipedia.org/wiki/PDF) (Portable Document Format) |
   | audio/mpeg | [MP3](https://en.wikipedia.org/wiki/MP3) or other [MPEG](https://en.wikipedia.org/wiki/MPEG) audio files |
   | audio/vnd.wave | [WAV](https://en.wikipedia.org/wiki/WAV) audio file |
   | image/gif | [GIF](https://en.wikipedia.org/wiki/GIF) image file |
   | image/jpeg | [JPEG](https://en.wikipedia.org/wiki/JPEG) image file |
   | image/png | [PNG](https://en.wikipedia.org/wiki/PNG) image file |
   | text/html | [HTML](https://en.wikipedia.org/wiki/HTML) document |
   | text/xml | [XML](https://en.wikipedia.org/wiki/XML) |
   | video/mp4 | [MP4](https://en.wikipedia.org/wiki/MP4) video file |
   | video/quicktime | [QuickTime](https://en.wikipedia.org/wiki/QuickTime) video file |

2. How to dispose of the generated content (inline / attachment).

   ````Python
   >>> from urllib.parse import quote
   >>>
   >>> response['content-type'] = 'application/pdf'
   >>> filename = quote('Python language specification.pdf')
   >>> filename
   'Python%E8%AF%AD%E8%A8%80%E8%A7%84%E8%8C%83.pdf'
   >>> response['content-disposition'] = f'attachment; filename="{filename}"'
   ````
   > Reminder: Chinese in the URL and request and response headers should be processed as [percent-encoded](https://zh.wikipedia.org/zh-hans/%E7%99%BE%E5%88%86% E5%8F%B7%E7%BC%96%E7%A0%81).

3. Generate CSV / Excel / PDF / statistical reports.

   - Transfer binary data to the browser.

     ````Python
     from io import BytesIO
     
     buffer = BytesIO()
     
     resp = HttpResponse(content_type='...')
     resp['Content-Disposition'] = 'attachment; filename="..."'
     resp.write(buffer.getvalue())
     ````

     ````Python
     from io import BytesIO
     
     import xlwt
     
     
     def get_style(name, color=0, bold=False, italic=False):
         font = xlwt.Font()
         font.name, font.colour_index, font.bold, font.italic = \
         name, color, bold, italic
         style = xlwt.XFStyle()
         style.font = font
         return style
     
def export_emp_excel(request):
         # Create an Excel workbook (using the third-party library xlwt)
         workbook = xlwt.Workbook()
         # Add worksheet to workbook
         sheet = workbook.add_sheet('employee details')
         # set header
         titles = ['number', 'name', 'supervisor', 'position', 'salary', 'department name']
         for col, title in enumerate(titles):
             sheet.write(0, col, title, get_style('HanziPenSC-W3', 2, True))
         # Query employee data using Django's ORM framework
         emps = Emp.objects.all().select_related('dept').select_related('mgr')
         cols = ['no', 'name', 'mgr', 'job', 'sal', 'dept']
         # Write the data of the employee table to the cells of the Excel worksheet through a nested loop
         for row, emp in enumerate(emps):
             for col, prop in enumerate(cols):
                 val = getattr(emp, prop, '')
                 if isinstance(val, (Dept, Emp)):
                     val = val.name
                 sheet.write(row + 1, col, val)
         # Write the binary data of the Excel file into memory
         buffer = BytesIO()
         workbook.save(buffer)
         # Output Excel file to browser through HttpResponse object
         resp = HttpResponse(buffer.getvalue())
         resp['content-type'] = 'application/msexcel'
         # If the file name has Chinese, it needs to be processed into percent code
         resp['content-disposition'] = 'attachment; filename="detail.xls"'
         return resp
     ````

   - Streaming of large files: `StreamingHttpResponse`.

     ````Python
     def download_file(request):
         file_stream = open('...', 'rb')
         # If the binary data of the file is large, it is best to use iterators to avoid excessive use of server memory
         file_iter = iter(lambda: file_stream.read(4096), b'')
         resp = StreamingHttpResponse(file_iter)
         # Chinese file names should be processed into percent code
         filename = quote('...', 'utf-8')
         resp['Content-Type'] = '...'
         resp['Content-Disposition'] = f'attachment; filename="{filename}"'
         return resp
     ````

     > Note: If you need to generate PDF files, you may need to install `reportlab`. In addition, using StreamingHttpResponse can only reduce the memory overhead, but if downloading a large file will cause a request to occupy server resources for a long time, it is better to generate the report in advance (you can consider using a scheduled task) and put it on the static resource server. Or it is accessed in the way of accessing static resources on the cloud storage server.

   - [ECharts](http://echarts.baidu.com/) or [Chart.js](https://www.chartjs.org/).

     - Idea: The backend only provides data in JSON format, and the frontend JavaScript renders the graph.

     ````Python
     def get_charts_data(request):
         """Get the JSON data of the statistical chart"""
         names = []
         totals = []
         # Get the specified database connection through connections and create a cursor object
         with connections['backend'].cursor() as cursor:
             # When using the ORM framework, you can use the aggregate() and annotate() methods of the object manager to implement grouping and aggregation function queries
             # Execute native SQL queries (if the ORM framework cannot meet business or performance requirements)
             cursor.execute('select dname, total from vw_dept_emp')
             for row in cursor.fetchall():
                 names.append(row[0])
                 totals.append(row[1])
         return JsonResponse({'names': names, 'totals': totals})
     ````

     ````HTML
     <!DOCTYPE html>
     <html lang="en">
     <head>
         <meta charset="UTF-8">
         <title>Statistical Chart</title>
         <style>
             #main {
                 width: 600px;
                 height: 400px;
             }
         </style>
     </head>
<body>
         <div id="main"></div>
         <script src="https://cdn.bootcss.com/echarts/4.2.0-rc.2/echarts.min.js"></script>
         <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
         <script>
             var myChart = echarts.init($('#main')[0]);
             $.ajax({
                 'url': 'charts_data',
                 'type': 'get',
                 'data': {},
                 'dataType': 'json',
                 'success': function(json) {
                     var option = {
                         title: {
                             text: 'Employee distribution chart'
                         },
                         tooltip: {},
                         legend: {
                             data:['Number of people']
                         },
                         xAxis: {
                             data: json.names
                         },
                         yAxis: {},
                         series: [{
                             name: 'Number',
                             type: 'bar',
                             data: json.totals
                         }]
                     };
                     myChart.setOption(option);
                 },
                 'error': function() {}
             });
         </script>
     </body>
     </html>
     ````


### Middleware

Question 1: What is the design philosophy behind middleware? (separate crosscutting concern function/intercept filter pattern)

Question 2: What are the different implementations of middleware? (refer to the code below)

Question 3: Describe the middleware built into Django and their execution order. (Recommended reading: [Django Official Documentation - Middleware - Middleware Ordering](https://docs.djangoproject.com/zh-hans/2.0/ref/middleware/#middleware-ordering))

#### Activate middleware

````Python
MIDDLEWARE = ​​[
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'common.middlewares.block_sms_middleware',
]
````

#### custom middleware


````Python
def simple_middleware(get_response):
    
    def middleware(request, *args, **kwargs):
        
response = get_response(request, *args, **kwargs)
        
return response
    
    return middleware
````

````Python
class MyMiddleware:
        
    def __init__(self, get_response):
        self.get_response = get_response
        
    def __call__(self, request):
        
        response = self.get_response(request)
       
        return response
````

````Python
class MyMiddleware(MiddlewareMixin):
    
    def __init__(self):
        pass
    
    def process_request(request):
        pass
    
    def process_view(request, view_func, view_args, view_kwargs):
        pass
    
    def process_template_response(request, response):
        pass
    
    def process_response(request, response):
        pass
    
    def process_exception(request, exception):
        pass
````

#### Built-in middleware

1. CommonMiddleware - basic setup middleware
   - DISALLOWED_USER_AGENTS - disallowed user agents (browser)
   - APPEND_SLASH - whether to append `/`
   - USE_ETAG - browser cache related

2. SecurityMiddleware - Security related middleware
   - SECURE_HSTS_SECONDS - time to force HTTPS
   - SECURE_HSTS_INCLUDE_SUBDOMAINS - whether HTTPS covers subdomains
   - SECURE_CONTENT_TYPE_NOSNIFF - whether to allow the browser to infer the content type
   - SECURE_BROWSER_XSS_FILTER - whether to enable cross-site scripting attack filter
   - SECURE_SSL_REDIRECT - whether to redirect to HTTPS connections
   - SECURE_REDIRECT_EXEMPT - exempts redirects to HTTPS

3. SessionMiddleware - Session Middleware

4. CsrfViewMiddleware - Prevent Cross-Site Identity Forgery Middleware

5. XFrameOptionsMiddleware - middleware for preventing clickjacking attacks

   ![](./res/click-jacking.png)

![](./res/builtin-middlewares.png)

### Form

1. Usage: Usually not used to generate form controls on the page (the coupling is too high and not easy to customize), it is mainly used to validate data.
2. Form properties and methods:
   - `is_valid()` / `is_multipart()`
   - `errors`/`fields`/`is_bound`/`changed_data`/`cleaned_data`
   - `add_error()` / `has_errors()` / `non_field_errors()`
   - `clean()`
3. Method of Form.errors:
   - `as_data()` / `as_json()` / `get_json_data()`

Question 1: What do `Form` and `ModelForm` in Django do? (usually not used to generate forms, mainly used to validate data)

Question 2: What problems should be paid attention to when uploading files in the form? (Form settings, multi-file upload, image preview (FileReader), Ajax upload files, how to store uploaded files, call cloud storage (such as [Alibaba Cloud OSS](https://www.aliyun.com/product/oss ), [Qiniu Cloud](https://www.qiniu.com/), [LeanCloud](https://leancloud.cn/storage/), etc.))

````HTML
<form action="" method="post" enctype="multipart/form-data">
    <input type="file" name="..." multiple>
    <input type="file" name="foo">
    <input type="file" name="foo">
    <input type="file" name="foo">
</form>
````

> Description: The preview effect of uploaded image files can be achieved through HTML5 FileReader.

> Note: Using cloud storage is usually a more reliable approach than configuring a distributed file system yourself, and cloud storage is usually not too expensive. Not only that, most cloud storage also provides features such as image cropping, watermarking, Video transcoding, CDN and other services. If you want to do the transcoding of the uploaded video files yourself, you need to install the third-party library ffmpeg, which can be called in the program to achieve transcoding.

### Cookies and Sessions

Question 1: What problems can be solved by using cookies? (User tracking, solve the stateless problem of HTTP protocol)

1. URL Rewriting

   ````
   http://www.abc.com/path/resource?foo=bar
   ````

2. Hidden Fields (Implicit Form Fields) - Buried Points

   ````HTML
   <form action="" method="post">
   
       <input type="hidden" name="foo" value="bar">
       
   </form>
   ````

3. Cookies - Temporary files (text files) in the browser - BASE64

Question 2: What is the relationship between Cookie and Session? (The identity of the session is saved and transmitted through cookies)

#### Session configuration

1. Middleware corresponding to Session: `django.contrib.sessions.middleware.SessionMiddleware`.

2. Session engine.

   - Database based (default)

     ````Python
     INSTALLED_APPS = [
         'django.contrib.sessions',
     ]
     ````

   - Cache based (recommended)

     ````Python
     SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
     SESSION_CACHE_ALIAS = 'session'
     ````

   - file based (basically not considered)

   - Cookie based (unreliable)

     ````Python
     SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies'
     ````

3. Cookie related configuration.

   ````Python
   SESSION_COOKIE_NAME = 'djang_session_id'
   SESSION_COOKIE_AGE = 1209600
   # If set to True, the cookie is a browser window-based cookie and will not persist
   SESSION_EXPIRE_AT_BROWSER_CLOSE = False
   SESSION_SAVE_EVERY_REQUEST = False
   SESSION_COOKIE_HTTPONLY = True
   ````

4. Session properties and methods.

   - `session_key` / `session_data` / `expire_date`
   - `__getitem__` / `__setitem__` / `__delitem__` / `__contains__`
   - `set_expiry()` / `get_expiry_age()` / `get_expiry_date()` - set/get session expiration time
   - `flush()` - destroys the session
   - `set_test_cookie()` / `test_cookie_worked()` / `delete_test_cookie()` - test whether the browser supports cookies (prompts the user that disabling cookies in the browser may affect the use of the website)

5. Session serialization.

   ````Python
   SESSION_SERIALIZER = 'django.contrib.sessions.serializers.JSONSerializer'
   ````

   - JSONSerializer (default in 1.6 and later) - If you want to put a custom object into the session, you will encounter the problem of "Object of type 'XXX' is not JSON serializable" (if the configuration uses Redis to save the session, django-redis uses Pickle serialization, this problem does not exist).
   - PickleSerializer (default before 1.6) - Not recommended due to security issues, but there is no risk as long as you don't deserialize malicious payloads constructed by users. For security vulnerabilities in this way, you can refer to the article "[Arbitrary Code Execution Vulnerability Practice and Payload Construction of Python Pickle"](http://www.polaris-lab.com/index.php/archives/178/) or " Software Architecture - Python Language Implementation" on this issue.

     > Note: If django_redis is used to integrate Redis as the session storage engine, then because django_redis encapsulates a PickleSerializer to provide serialization, the above problems do not exist, and the value stored in Redis is the result of pickle serialization.


### cache

#### configure cache


````Python
CACHES = {
    # default cache
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': [
            'redis://1.2.3.4:6379/0',
        ],
        'KEY_PREFIX': 'teamproject',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 1000,
            },
            'PASSWORD': 'yourpass',
        }
    },
    # page cache
    'page': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': [
            'redis://1.2.3.4:6379/1',
        ],
        'KEY_PREFIX': 'teamproject:page',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 500,
            },
            'PASSWORD': 'yourpass',
        }
    },
    # session cache
    'session': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': [
            'redis://1.2.3.4:6379/2',
        ],
        'KEY_PREFIX': 'teamproject:session',
        'TIMEOUT': 1209600,
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 2000,
            },
            'PASSWORD': 'yourpass',
        }
    },
    # interface data cache
    'api': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': [
            'redis://1.2.3.4:6379/3',
        ],
        'KEY_PREFIX': 'teamproject:api',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 500,
            },
            'PASSWORD': 'yourpass',
        }
    },
}
````

> Description: Isolating cached data through multiple databases provided at the bottom of Redis helps in the management of cached data. If Redis master-slave replication (read-write separation) is configured, multiple Redis connections can be configured in the LOCATION list. The first one is regarded as the master for write operations, and the latter is regarded as the slave for read operations.

#### Sitewide cache

````Python
MIDDLEWARE_CLASSES = [
    'django.middleware.cache.UpdateCacheMiddleware',
    ...
    'django.middleware.common.CommonMiddleware',
    ...
    'django.middleware.cache.FetchFromCacheMiddleware',
]

CACHE_MIDDLEWARE_ALIAS = 'default'
CACHE_MIDDLEWARE_SECONDS = 300
CACHE_MIDDLEWARE_KEY_PREFIX = 'djang:cache'
````
#### View layer cache

````Python
from django.views.decorators.cache import cache_page
from django.views.decorators.vary import vary_on_cookie


@cache_page(timeout=60 * ​​15, cache='page')
@vary_on_cookie
def my_view(request):
    pass
````

````Python
from django.views.decorators.cache import cache_page

urlpatterns = [
    url(r'^foo/([0-9]{1,2})/$', cache_page(60 * 15)(my_view)),
]
````
#### Other content

1. Template fragment cache.

   - `{% load cache %}`
   - `{% cache %}` / `{% endcache %}`

2. Use the underlying API to access the cache.

   ````Python
   >>> from django.core.cache import cache
   >>>
   >>> cache.set('my_key', 'hello, world!', 30)
   >>> cache.get('my_key')
   >>> cache.clear()
   ````

   ````Python
   >>> from django.core.cache import caches
   >>> cache1 = caches['page']
   >>> cache2 = caches['page']
   >>> cache1 is cache2
   True
   >>> cache3 = caches['session']
   >>> cache2 is cache3
   false
   ````

   ````Python
   >>> from django_redis import get_redis_connection
   >>>
   >>> redis_client = get_redis_connection()
   >>> redis_client.hgetall()
   ````


### log

#### log level

NOTSET < DEBUG < INFO < WARNING < ERROR < CRITICAL

#### log configuration

````Python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    # Configure the log formatter
    'formatters': {
        'simple': {
            'format': '%(asctime)s %(module)s.%(funcName)s: %(message)s',
            'datefmt': '%Y-%m-%d %H:%M:%S',
        },
        'verbose': {
            'format': '%(asctime)s %(levelname)s [%(process)d-%(threadName)s] '
                      '%(module)s.%(funcName)s line %(lineno)d: %(message)s',
            'datefmt': '%Y-%m-%d %H:%M:%S',
        }
    },
    # configure log filter
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    # configure the log handler
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'level': 'DEBUG',
            'filters': ['require_debug_true'],
            'formatter': 'simple',
        },
        'file1': {
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'filename': 'access.log',
            'when': 'W0',
            'backupCount': 12,
            'formatter': 'simple',
            'level': 'INFO',
        },
        'file2': {
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'filename': 'error.log',
            'when': 'D',
            'backupCount': 31,
            'formatter': 'verbose',
            'level': 'WARNING',
        },
    },
    # configure the logger
    'loggers': {
        'django': {
            'handlers': ['console', 'file1', 'file2'],
            'propagate': True,
            'level': 'DEBUG',
        },
    }
}
````

[Official example of logging configuration](https://docs.djangoproject.com/zh-hans/2.0/topics/logging/#s-examples).

#### log analysis

1. Linux related commands: head, tail, grep, awk, uniq, sort

   ```Shell
   tail -10000 access.log | awk '{print $1}' | uniq -c | sort -r
   ````

2. Real-time log file analysis: Python + regular expression + Crontab

3. ["Python Log Analysis Tool"](https://github.com/jkklee/web_log_analyse).

4. ["Centralized Logging System ELK"](https://www.ibm.com/developerworks/cn/opensource/os-cn-elk/index.html).

   - ElasticSearch: A search engine that implements full-text retrieval.
   - Logstash: Responsible for collecting logs from specified nodes.
   - Kibana: log visualizer.

5. Big data log processing: Flume+Kafka log collection, Storm/Spark real-time data processing, Impala real-time query.

### RESTful

Question 1: What exactly does a RESTful architecture solve? (URL has self-description, decoupling and decoupling of resource representation and view, interoperability to build microservices and integration of third-party systems, statelessness to improve horizontal scalability)

Question 2: Did the project encounter some problems or hidden dangers when using the RESTful architecture? (Restriction on resource access, checking of resource affiliation, avoiding leakage of business information, preventing possible attacks)

> Supplement: The following security-related response headers were mentioned earlier when we talked about middleware.
>
> - X-Frame-Options: DENY
> - X-Content-Type-Options: nosniff
> - X-XSS-Protection: 1; mode=block;
> - Strict-Transport-Security: max-age=31536000;

Question 3: How to protect sensitive information in the API and prevent replay attacks? (digest and token)

Recommended reading: ["How to Effectively Prevent API Replay Attacks"](https://help.aliyun.com/knowledge_detail/50041.html).


#### Using djangorestframework

Install djangorestfrmework (for the convenience of description, hereinafter referred to as DRF).

```Shell
pip install djangorestframework
````

Configure DRF.

````Python
INSTALLED_APPS = [
    
    'rest_framework',
    
]

REST_FRAMEWORK = {
    # Configure default page size
    'PAGE_SIZE': 10,
    # Configure the default pagination class
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    # configure exception handler
    # 'EXCEPTION_HANDLER': 'api.exceptions.exception_handler',
    # configure default parser
    # 'DEFAULT_PARSER_CLASSES': (
    # 'rest_framework.parsers.JSONParser',
    # 'rest_framework.parsers.FormParser',
    # 'rest_framework.parsers.MultiPartParser',
    # ),
    # Configure the default current limiting class
    # 'DEFAULT_THROTTLE_CLASSES': (),
    # Configure the default authorization class
    # 'DEFAULT_PERMISSION_CLASSES': (
    # 'rest_framework.permissions.IsAuthenticated',
    # ),
    # Configure the default authentication class
    # 'DEFAULT_AUTHENTICATION_CLASSES': (
    # 'rest_framework_jwt.authentication.JSONWebTokenAuthentication',
    # ),
}
````

#### Write the serializer

````Python
from rest_framework import serializers
from rest_framework.serializers import ModelSerializer

from common.models import District, HouseType, Estate, Agent


class DistrictSerializer(ModelSerializer):

    class Meta:
        model = District
        fields = ('distid', 'name')


class HouseTypeSerializer(ModelSerializer):

    class Meta:
        model = HouseType
        fields = '__all__'


class AgentSerializer(ModelSerializer):

    class Meta:
        model = Agent
        fields = ('agentid', 'name', 'tel', 'servstar', 'certificated')


class EstateSerializer(ModelSerializer):
    district = serializers.SerializerMethodField()
    agents = serializers.SerializerMethodField()

    @staticmethod
    def get_agents(estate):
        return AgentSerializer(estate.agents, many=True).data

    @staticmethod
    def get_district(estate):
        return DistrictSerializer(estate.district).data

    class Meta:
        model = Estate
        fields = '__all__'
````

#### Method 1: Using a decorator

````Python
@api_view(['GET'])
@cache_page(timeout=None, cache='api')
def provinces(request):
    queryset = District.objects.filter(parent__isnull=True)
    serializer = DistrictSerializer(queryset, many=True)
    return Response(serializer.data)


@api_view(['GET'])
@cache_page(timeout=300, cache='api')
def cities(request, provide):
    queryset = District.objects.filter(parent__distid=provid)
    serializer = DistrictSerializer(queryset, many=True)
    return Response(serializer.data)
````

````Python
urlpatterns = [
    path('districts/', views.provinces, name='districts'),
    path('districts/<int:provid>/', views.cities, name='cities'),
]
````

> Description: The view decorator (@cache_page) that comes with Django is used above to cache the data returned by the API interface.

#### Method 2: Using APIView and its subclasses

Better reuse code, don't "reinvent the wheel".

````Python
class HouseTypeApiView(CacheResponseMixin, ListAPIView):
    queryset = HouseType.objects.all()
    serializer_class = HouseTypeSerializer
````

````Python
urlpatterns = [
    path('housetypes/', views.HouseTypeApiView.as_view(), name='housetypes'),
]
````

> Description: The above uses the CacheResponseMixin mixin class provided by drf_extensions to cache interface data. If the method for obtaining data is overridden, you can use @cache_response provided by drf_extensions to cache the interface data, or you can use a custom function to generate the key in the cache. Of course, another option is to use the @method_decorator decorator provided by Django to process the @cache_page decorator as a decorator for the decorated method, so that the cache service can also be provided.

The `drf-extensions` configuration is shown below.

````Python
# Configure DRF extensions to support caching API interface call results
REST_FRAMEWORK_EXTENSIONS = {
    'DEFAULT_CACHE_RESPONSE_TIMEOUT': 300,
    'DEFAULT_USE_CACHE': 'default',
    # Configure the key function that caches a single object by default
    'DEFAULT_OBJECT_CACHE_KEY_FUNC': 'rest_framework_extensions.utils.default_object_cache_key_func',
    # Configure the key function of the default cache object list
    'DEFAULT_LIST_CACHE_KEY_FUNC': 'rest_framework_extensions.utils.default_list_cache_key_func',
}
````

#### Method 3: Using ViewSet and its subclasses

````Python
class HouseTypeViewSet(CacheResponseMixin, viewsets.ModelViewSet):
    queryset = HouseType.objects.all()
    serializer_class = HouseTypeSerializer
    pagination_class = None
````

````Python
router = DefaultRouter()
router.register('housetypes', views.HouseTypeViewSet)

urlpatterns += router.urls
````

djangorestframework provides a page customized based on Bootstrap to display the JSON data returned by the interface. Of course, you can also use tools such as [POSTMAN](https://www.getpostman.com/) to test the API interface.

#### Additional Notes

Here are a few questions related to the front end by the way.

Question 1: How to enable the browser to initiate DELETE/PUT/PATCH?

````HTML
<form method="post">
    
    <input type="hidden" name="_method" value="delete">
    
</form>
````

````Python
if request.method == 'POST' and '_method' in request.POST:
    request.method = request.POST['_method'].upper()
````

````HTML
<script>
    $.ajax({
        'url': '/api/provinces',
        'type': 'put',
        'data': {},
        'dataType': 'json',
        'success': function(json) {
            // Web = Label (content) + CSS (display) + JS (behavior)
            // JavaScript = ES + BOM + DOM
            // DOM manipulation to achieve partial refresh of the page
        },
        'error': function() {}
    });
    $.getJSON('/api/provinces', function(json) {
        // DOM manipulation to achieve partial refresh of the page
    });
</script>
````

Question 2: How to resolve a conflict of a definition (eg $function) between multiple JavaScript libraries?

````HTML
<script src="js/jquery.min.js"></script>
<script src="js/abc.min.js"></script>
<script>
    // $ is already taken by a later loaded JavaScript library
    // But you can use jQuery directly bound to the window object instead of $
    jQuery(function() {
        jQuery('#okBtn').on('click', function() {});
    });
</script>
````
````HTML
<script src="js/abc.min.js"></script>
<script src="js/jquery.min.js"></script>
<script>
    // Give $ to other JavaScript libraries
jQuery.noConflict();
jQuery(function() {
        jQuery('#okBtn').on('click', function() {});
    });
</script>
````

Question 3: How to convert between jQuery objects and native DOM objects?

````HTML
<button id="okBtn">Click me</button>
<script src="js/jquery.min.js"></script>
<script>
    var btn = document.getElementById('okBtn'); // native JavaScript object (relatively troublesome to use)
    var $btn = $('#okBtn'); // jQuery object (has more properties and methods and no browser compatibility issues)
    $btn.on('click', function() {});
    // $(btn) can convert native JavaScript objects to jQuery objects
    // $btn.get(0) or $btn[0] to get the native JavaScript object
</script>
````

#### filter data

If you need to filter data (set filter conditions, sorting conditions, etc. on the data interface), you can use the `django-filter` tripartite library to achieve it.

```Shell
pip install django-filter
````

````Python
INSTALLED_APPS = [
    
    'django_filters',

]
REST_FRAMEWORK = {
  
    'DEFAULT_FILTER_BACKENDS': (
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.OrderingFilter',
    ),
    
}
````

````Python
from django.utils.decorators import method_decorator
from django.views.decorators.cache import cache_page
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import OrderingFilter
from rest_framework.generics import RetrieveAPIView, ListCreateAPIView

from api.serializers import EstateSerializer
from common.models import Estate


@method_decorator(decorator=cache_page(timeout=120, cache='api', key_prefix='estates'), name='get')
class EstateView(RetrieveAPIView, ListCreateAPIView):
    queryset = Estate.objects.all().select_related('district').prefetch_related('agents')
    serializer_class = EstateSerializer
    filter_backends = (DjangoFilterBackend, OrderingFilter)
    filter_fields = ('name', 'district')
    ordering = ('-hot', )
    ordering_fields = ('hot', 'estateid')
````

````Python
from django_filters import rest_framework as drf
from common.models import HouseInfo


class HouseInfoFilter(drf.FilterSet):
    """Customize listing data filter"""

    title = drf.CharFilter(lookup_expr='starts')
    dist = drf.NumberFilter(field_name='district')
    min_price = drf.NumberFilter(field_name='price', lookup_expr='gte')
    max_price = drf.NumberFilter(field_name='price', lookup_expr='lte')
    type = drf.NumberFilter()

    class Meta:
        model = HouseInfo
        fields = ('title', 'district', 'min_price', 'max_price', 'type')
````

````Python
class HouseInfoViewSet(CacheResponseMixin, ReadOnlyModelViewSet):
    queryset = HouseInfo.objects.all() \
        .select_related('type', 'district', 'estate', 'agent') \
        .prefetch_related('tags').order_by('-pubdate')
    serializer_class = HouseInfoSerializer
    filter_backends = (DjangoFilterBackend, OrderingFilter)
    filterset_class = HouseInfoFilter
    ordering = ('price',)
    ordering_fields = ('price', 'area')
````

#### Authentication

Looking at the code of the APIView class in DRF, it can be seen that the default authentication scheme of DRF is `DEFAULT_AUTHENTICATION_CLASSES`. If you modify the authentication_classes, you can customize the authentication scheme yourself.

````Python
class APIView(View):

    # The following policies may be set at either globally, or per-view.
    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES
    parser_classes = api_settings.DEFAULT_PARSER_CLASSES
    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES
    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES
    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES
    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS
    metadata_class = api_settings.DEFAULT_METADATA_CLASS
    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS

   # Omit the following code here
````

````Python
DEFAULTS = {
    # Base API policies
    'DEFAULT_RENDERER_CLASSES': (
        'rest_framework.renderers.JSONRenderer',
        'rest_framework.renderers.BrowsableAPIRenderer',
    ),
    'DEFAULT_PARSER_CLASSES': (
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.FormParser',
        'rest_framework.parsers.MultiPartParser'
    ),
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.BasicAuthentication'
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.AllowAny',
    ),
    'DEFAULT_THROTTLE_CLASSES': (),
    'DEFAULT_CONTENT_NEGOTIATION_CLASS': 'rest_framework.negotiation.DefaultContentNegotiation',
    'DEFAULT_METADATA_CLASS': 'rest_framework.metadata.SimpleMetadata',
    'DEFAULT_VERSIONING_CLASS': None,

    # Omit the following code here
}
````

A custom authentication class that inherits `BaseAuthentication` and overrides the `authenticate(self, request)` method to determine the user identity through the userid and token in the request. If authentication is successful, the method should return a 2-tuple (user and token information), otherwise raise an exception. The `authenticate_header(self, request)` method can also be overridden to return a string that will be used as the value of the WWW-Authenticate response header in the `HTTP 401 Unauthorized` response. If this method is not overridden, the authentication scheme will return an `HTTP 403 Forbidden` response when an unauthenticated request is denied access.

````Python
class MyAuthentication(BaseAuthentication):
    """Custom user authentication class"""

    def authenticate(self, request):
        try:
            token = request.GET['token'] or request.POST['token']
            user_token = UserToken.objects.filter(token=token).first()
            if user_token:
                return user_token.user, user_token
            else:
                raise AuthenticationFailed('Please provide a valid user ID')
        except KeyError:
            raise AuthenticationFailed('Please provide a valid user ID')

    def authenticate_header(self, request):
        pass
````

Use a custom authentication class.

````Python
class EstateViewSet(CacheResponseMixin, ModelViewSet):
    # Specify how to get data (resources) through queryset
    queryset = Estate.objects.all().select_related('district').prefetch_related('agents')
    # Specify how to serialize data through serializer_class
    serializer_class = EstateSerializer
    # Specify which fields to filter data on
    filter_fields = ('district', 'name')
    # Specify which fields to sort the data by
    ordering_fields = ('hot', )
    # Specify the class to use for user authentication
    authentication_classes = (MyAuthentication, )
````

> Note: You can also set a custom authentication class as the default authentication method in the Django configuration file.

#### Granted permission

Permission checks are always run at the very beginning of the view, before any other code is allowed to proceed. The simplest permission is to allow authenticated users and deny access to unauthenticated users. This corresponds to the `IsAuthenticated` class in dfr, which can be used to replace the default `AllowAny` class. Permission policies can be set globally with `DEFAULT_PERMISSION_CLASSES` in Django's DRF configuration.

````Python
REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    )
}
````

Authentication strategies can also be set on views based on the `APIView` class.

````Python
from rest_framework.permissions import IsAuthenticated
from rest_framework.views import APIView

class ExampleView(APIView):
    permission_classes = (IsAuthenticated, )
    #Omit other code here
````

Or set on a view function based on the `@api_view` decorator.

````Python
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated

@api_view(['GET'])
@permission_classes((IsAuthenticated, ))
def example_view(request, format=None):
    #Omit other code here
````

Custom permissions need to inherit `BasePermission` and implement one or both of the following methods. Below is the code for BasePermission.

````Python
@six.add_metaclass(BasePermissionMetaclass)
class BasePermission(object):
    """
    A base class from which all permission classes should inherit.
    """

    def has_permission(self, request, view):
        """
        Return `True` if permission is granted, `False` otherwise.
        """
        return True

    def has_object_permission(self, request, view, obj):
        """
        Return `True` if permission is granted, `False` otherwise.
        """
        return True
````

The method should return True if the request was granted access, False otherwise. The following example demonstrates blocking IP addresses in the blacklist from accessing interface data (this is useful when anti-crawlers).

````Python
from rest_framework import permissions


class BlacklistPermission(permissions.BasePermission):
    """
    Global permission check for blacklisted IPs.
    """

    def has_permission(self, request, view):
        ip_addr = request.META['REMOTE_ADDR']
        blacklisted = Blacklist.objects.filter(ip_addr=ip_addr).exists()
        return not blacklisted
````

If you want to achieve more complete permission verification, you can consider RBAC or ACL.

1. RBAC - Role-Based Access Control as shown in the figure below.

   ![](./res/rbac-basic.png)

   ![](./res/rbac-full.png)

2. ACL - Access Control List (each user binds his own access whitelist or blacklist).

#### Access limit

You can modify the `DEFAULT_THROTTLE_CLASSES` and `DEFAULT_THROTTLE_RATES` values ​​in the dfr configuration to set the global default current limiting policy. E.g:

````Python
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_CLASSES': (
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle'
    ),
    'DEFAULT_THROTTLE_RATES': {
        'anon': '3/min',
        'user': '10000/day'
    }
}
````

The frequency description used in `DEFAULT_THROTTLE_RATES` may include `second`, `minute`, `hour` or `day`.

If you want to set throttling individually for an interface, you can set a throttling policy on each view or viewset as follows:

````Python
from rest_framework.throttling import UserRateThrottle
from rest_framework.views import APIView


class ExampleView(APIView):
    throttle_classes = (UserRateThrottle, )
    # Omit the following code here
````

or

````Python
@api_view(['GET'])
@throttle_classes([UserRateThrottle, ])
def example_view(request, format=None):
    # Omit the following code here
````

Of course, you can also customize the current limiting strategy by inheriting `SimpleRateThrottle`, usually you need to override the `allow_request` and `wait` methods.

### Asynchronous tasks and scheduled tasks

#### Celery Apps

Celery is a simple, flexible, and reliable distributed system for handling large amounts of messages, and provides the necessary tools to maintain such a system. It is a task queue focused on real-time processing and also supports task scheduling.

Recommended reading: ["Celery Official Documentation Chinese Version"](http://docs.jinkan.org/docs/celery/), which has extremely detailed configuration and usage guidelines.

![](./res/celery_architecture.png)

Celery is a service that does not provide queues itself. Officially, it is recommended to use RabbitMQ or Redis to implement message queue services. The former is a better choice. It has made a very good implementation of AMQP (Advanced Message Queuing Protocol).

1. Install RabbitMQ.

   ```Shell
   docker pull rabbitmq
   docker run -d -p 5672:5672 --name myrabbit rabbitmq
   docker container exec -it myrabbit /bin/bash
   ````

2. Create users, resources, and assign operational permissions.

   ```Shell
   rabbitmqctl add_user luohao 123456
   rabbitmqctl set_user_tags luohao administrator
   rabbitmqctl add_vhost vhost1
   rabbitmqctl set_permissions -p vhost1 luohao ".*" ".*" ".*"
   ````

3. Create a Celery instance.

   ````Python
   # register environment variables
   os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'Project name.settings')
   
   # Create Celery instance
   app = celery. Celery(
       'fangtx',
       broker='amqp://luohao:123456@1.2.3.4:5672/vhost1'
   )
   
   # Read Celery configuration information from the project's configuration file
   # app.config_from_object('django.conf:settings')
   # Read Celery configuration information from the specified file (eg celery_config.py)
   # app.config_from_object('celery_config')
   
   # Let Celery automatically discover asynchronous tasks/timed tasks from the application specified by the parameter
   # app.autodiscover_tasks(['common', ])
   # Let Celery automatically discover asynchronous tasks/timed tasks from all registered applications
   app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)
   ````

4. Start Celery to create a worker (a message consumer).

   ```Shell
   celery -A <name> worker -l debug &
   ````

5. Execute asynchronous tasks.

   ````Python
   @app.task
   def send_email(from_user, to_user, cc_user, subject, content):
       pass
   
   
   # message producer
   send_email.delay('', [], [], '', '')
   ````

6. Create a scheduled task.

   ````Python
   # Configure timed tasks (scheduled tasks)
   app.conf.update(
       timezone=settings.TIME_ZONE,
       enable_utc=True,
       # Scheduled tasks (scheduled tasks) are equivalent to message producers
       # If there are only producers and no consumers then messages will be backlogged in the message queue
       # When the project is actually deployed in the future, the producer, consumer, and message queue may all be different nodes
       beat_schedule={
           'task1': {
               'task': 'common.tasks.scheduled_task',
               'schedule': crontab('*', '*', '*', '*', '*'),
               'args': ('...', )
           },
       },
   )
   ````

   ````Python
   @app.task
   def scheduled_task(*args, **kwargs):
       pass
   ````

7. Start Celery to create a beat (a message producer) that executes scheduled tasks.

   ```Shell
   celery -A <name> beat -l info
   ````

8. Check the message queue status.

   ```Shell
   rabbitmqctl list_queues -p vhost1
   ````

9. Monitor Celery - Celery can be monitored by flower.

   ```Shell
   pip install flower
   celery flower --broker=amqp://luohao:123456@120.77.222.217:5672/vhost1
   ````

### other problems

Question 1: How to solve the problem of JavaScript getting data across domains? (django-cors-headers)

````Python
INSTALLED_APPS = [
    'corsheaders',
]

MIDDLEWARE = ​​[
    'corsheaders.middleware.CorsMiddleware',
]

CORS_ORIGIN_ALLOW_ALL = True
# Configure cross-domain whitelist
# CORS_ORIGIN_WHITELIST = ('www.abc.com', 'www.baidu.com')
# CORS_ORIGIN_REGEX_WHITELIST = ('...', )
# CORS_ALLOW_CREDENTIALS = True
# CORS_ALLOW_METHODS = ('GET', 'POST', 'PUT', 'DELETE')
````

Question 2: How are website images (watermarks, cropping) and videos (screenshots, watermarks, transcoding) handled? (cloud storage, FFmpeg)

Question 3: How does a website set up a (static resource) file system? (FastDFS, cloud storage, CDN)

### safety protection

Question 1: What is Cross-Site Scripting (XSS) and how to prevent it? (sanitize submissions)

Question 2: What is Cross-Site Identity Forgery (CSRF) and how to prevent it? (using random tokens)

Question 3: What is SQL Injection and how to prevent it? (Do not concatenate SQL statements, avoid using single quotes)

Question 4: What is Click-hacking and how to prevent it? (`<iframe>` is not allowed to load non-same-origin site content)

#### Security measures provided by Django

API for signing data

   ````Python
>>> from django.core.signing import Signer
>>> signer = Signer()
>>> value = signer.sign('hello, world!')
>>> value
'hello, world!:BYMlgvWMTSPLxC-DqxByleiMVXU'
>>> signer.unsign(value)
'hello, world!'
>>>
>>> signer = Signer(salt='yoursalt')
>>> signer.sign('hello, world!')
'hello, world!:9vEvG6EA05hjMDB5MtUr33nRA_M'
>>>
>>> from django.core.signing import TimestampSigner
>>> signer = TimestampSigner()
>>> value = signer.sign('hello, world!')
>>> value
'hello, world!:1fpmcQ:STwj464IFE6eUB-_-hyUVF3d2So'
>>> signer.unsign(value, max_age=5)
Traceback (most recent call last):
    File "<console>", line 1, in <module>
    File "/Users/Hao/Desktop/fang.com/venv/lib/python3.6/site-packages/django/core/signing.py", line 198, in unsign
    'Signature age %s > %s seconds' % (age, max_age))
    django.core.signing.SignatureExpired: Signature age 21.020604848861694 > 5 seconds
>>> signer.unsign(value, max_age=120)
'hello, world!'
   ````

CSRF Tokens and Gadgets

````HTML
{% csrf_token %}
````

- @csrf_exempt: Exempt token
- @csrf_protect: Provides token protection
- @require_csrf_token: Provides token protection
- @ensure_csrf_cookie: Force the view to send a cookie with a token

> Note: You can install the EditThisCookie plug-in in the Chrome browser to view cookies conveniently.


#### Protection of User Sensitive Information

1. Hash digest (signature)

   ````Python
   >>> import hashlib
   >>>
   >>> md5_hasher = hashlib.md5()
   >>> md5_hasher.update('hello, world!'.encode())
   >>> md5_hasher.hexdigest()
   '3adbbad1791fbae3ec908894c4963870'
   >>>
   >>> sha1_hasher = hashlib.sha1()
   >>> sha1_hasher.update('hello, world!'.encode())
   >>> sha1_hasher.update('goodbye, world!'.encode())
   >>> sha1_hasher.hexdigest()
   '1f09d30c707d53f3d16c530dd73d70a6ce7596a9'
   ````

2. Encryption and decryption (symmetric encryption and asymmetric encryption)

   ```Shell
   pip install pycrypto
   ````

   AES symmetric encryption:

   ````Python
   >>> from hashlib import md5
   >>>
   >>> from Crypto.Cipher import AES
   >>> from Crypto import Random
   >>>
   >>> key = md5(b'mysecret').hexdigest()
   >>> iv = Random.new().read(AES.block_size)
   >>> str1 = 'I love you all! '
   >>> str2 = AES.new(key, AES.MODE_CFB, iv).encrypt(str1)
   b'p\x96o\x85\x0bq\xc4-Y\xc4\xbcp\n)&'
   >>> str3 = AES.new(key, AES.MODE_CFB, iv).decrypt(str2).decode()
   'I love you! '
   ````

   RSA asymmetric encryption:

   ````Python
   >>> from Crypto.PublicKey import RSA
   >>> # generate key pair
   >>> key_pair = RSA.generate(2048)
   >>> # import public key
   >>> pub_key = RSA.importKey(key_pair.publickey().exportKey())
   >>> # import private key
   >>> pri_key = RSA.importKey(key_pair.exportKey())
   >>> # plaintext
   >>> message1 = 'hello, world!'.encode()
   >>> # encrypted data
   >>> message2 = pub_key.encrypt(message1, None)
   (b'\x03\x86t\xa0\x00\xc4\xea\xd2\x80\xed\xa7YN7\x07\xff\x88\xaa\x1eW\x0cmH0\x06\xa7\'\xbc<w@q\x8b\ xaf\xf7:g\x92{=\xe2E\xa5@\x1as2\xdd\xcb\x8e[\x98\x85\xdf,X\xecj.U\xd6\xa7W&u\'Uz"\x0f\x0e\\< \xa4\xfavC\x93\xa7\xbcO"\xb9a\x06]<.\xc1\r1}*\xdf\xccdqXML\x93\x1b\xe9\xda\xdf\xab|\xf8\x18\xe4\x99\ xbb\x7f\x18}\xd9\x9a\x1e*J\\\xca\x1a\xd1\x85\xf7t\x81\xd95{\x19\xc9\x81\xb6^}\x9c5\xca\xfe\xcf\ xc8\xd8M\x9a\x8c-\xf1t\xee\xf9\x12\x90\x01\xca\x92~\x00c5qg5g\x95&\x10\xb1\x0b\x1fo\x95\xf2\xbc\x8d\xf3f"@\ xc5\x188\x0bX\x9cfo\xea\x97\x05@\xe5\xb2\xda\xb8\x97a\xa5w\xa8\x01\x9a\xa5N\xc4\x81\x8d\x0f<\x96iU\xd3\x95\ xacJZs\xab_ #\xee\xf9\x0f\xf2\x12\xdb\xfc\xf8g\x18v\x02k+\xda\x16Si\xbf\xbb\xec\xf7w\x90\xde\xae\x97\t\xed{} 5\xd0',)
   >>> # decrypt data
   >>> message3 = pri_key.decrypt(message2)
   'hello, world!'
   ````

#### Security related advice

1. Although Django comes with solid security protections, it is still important to deploy applications in the right way, taking advantage of the security protections provided by the web server, operating system, and other components.
2. Remember to keep the Python code outside the document root directory of the web server to avoid accidental disclosure of the code.
3. Handle user-uploaded files with care.
4. Django itself does not limit the number of requests (including requests to authenticate users). In order to prevent brute force attacks and cracking, you can consider using a one-time consumption verification code or limit the number of such requests.
5. Put cache systems, database servers, and important resource servers behind a second-level firewall (not in the DMZ).

### Test related

Testing is the process of finding and flagging defects. A so-called defect is any difference between the actual result and the expected result. In some places, testing is also considered to be the process of executing a program for the purpose of finding bugs. Testing is done to make the product achieve the following goals:

1. Satisfy the needs and satisfy the users
2. Improve the market share of the product
3. Build trust in the product
4. Reduce development and maintenance costs

#### function test

A software unit passes its functional test if it behaves exactly as it was developed to.
 - White box testing: developers implement it themselves, the most basic form is unit testing, as well as integration testing and system testing.
 - Black box testing: performed by someone outside the development team, with no visibility into the test code, treating the system under test as a black box. Usually performed by testers or QA engineers, web applications can be automated through testing frameworks like Selenium.

#### Performance Testing

Testing of software for its responsiveness and robustness under high workloads.

- Load Test: A test performed under a specific load.

 - Stress testing: performance testing under sudden or extreme conditions.

#### Security Testing

Sensitive data of the system can only be accessed after authentication and authorization.

#### Other tests

Usability Testing / Installation Testing / Accessibility Testing

#### unit test

Methods for testing functions and objects (the smallest and most basic unit of a program). Determine whether the unit under test meets the design requirements by comparing the actual output with the expected output and various assertion conditions.

- Test cases
- Test firmware - something to use every time you test.
- Test Suite (Test Set) - A collection that combines multiple test cases.

````Python
class UtilTest(unittest.TestCase):

    def setUp(self):
        self.pattern = re.compile(r'\d{6}')

    def test_gen_mobile_code(self):
        for _ in range(100):
            self.assertIsNotNone(self.pattern.match(gen_mobile_code()))

    def test_to_md5_hex(self):
        md5_dict = {
            '123456': 'e10adc3949ba59abbe56e057f20f883e',
            '123123123': 'f5bb0c8de146c67b44babbf4e6584cc0',
            '1qaz2wsx': '1c63129ae9db9c60c3e8aa94d3e00495',
        }
        for key, value in md5_dict.items():
            self.assertEqual(value, to_md5_hex(key))
````

Assertion method of `TestCase`:

- assertEqual / assertNotEqual
- assertTrue / assertFalse / assertIsNot
- assertRaise / assertRaiseRegexp
- assertAlmostEqual / assertNotAlmostEqual
- assertGreater / assertGreaterEqual / assertLess / assertLessEqual
- assertRegexpMatches / assertNotRegexpMatches
- assertListEqual / assertSetEqual / assertTupleEqual / assertDictEqual

You can use nose2 or pytest to assist in unit testing, and test coverage can be assessed through cov-core or pytest-cov. Coverage is expressed as a percentage. For example, if the test code executes every line of the program, the coverage rate is 100%. At this time, there is almost no embarrassing situation that a new program suddenly fails to run after it goes online. Coverage doesn't care what the code content is. Coverage is an indicator used to check "insufficient test code and omissions in testing". "Whether the test content is appropriate" does not belong to it.

```Shell
pip install nose2 pytest cov-core pytest-cov
````

Selenium can be used to implement automated testing of web applications, it can also be used for screen scraping and browser behavior simulation, and it can also be used to crawl dynamic data on pages through crawlers. Selenium actually consists of three parts:

- Selenium IDE: A plug-in embedded into the browser that can record and play back scripts.

  ![](./res/selenium_ide.png)

- Selenium WebDriver: API that supports multiple languages ​​to control the browser.

- Selenium Standalone Server: Selenium Grid, Remote Control, Distributed Deployment.

```Shell
pip install selenium
````

````Python
from selenium import webdriver
import pytest
import contextlib


@pytest.fixture(scope='session')
def chrome():
    # Set to use headless browser (will not open browser window)
    options = webdriver.ChromeOptions()
    options.add_argument('--headless')
    driver = webdriver.Chrome(options=options)
    yield driver
    driver.quit()


def test_baidu_index(chrome):
    chrome.get('https://www.baidu.com')
    assert chrome.title == 'Baidu, you will know'
````

In addition to Selenium, there is a web automation testing tool called Robot Framework.

```Shell
nose2 -v -C
pytest --cov
````

```Shell
Ran 7 tests in 0.002s

OK
Name Stmts Miss Cover
--------------------------------------------------------
example01.py 15 0 100%
example02.py 49 49 0%
example03.py 22 22 0%
example04.py 61 61 0%
example05.py 29 29 0%
example06.py 39 39 0%
example07.py 19 19 0%
example08.py 27 27 0%
example09.py 18 18 0%
example10.py 19 19 0%
example11.py 22 22 0%
example12.py 28 28 0%
example13.py 28 28 0%
test_ddt_example.py 18 0 100%
test_pytest_example.py 11 6 45%
test_unittest_example.py 22 0 100%
--------------------------------------------------------
TOTAL 427 367 14%
````

In the testing process, it is necessary to isolate various external dependencies (database, external interface calls, time dependencies), which include two aspects:

1. Data source: data localization / put in memory / rollback after testing

2. Resource virtualization: stub/stub, imitation/mock, fake

   - stub: a stub generated during testing for the function that provides the response
   - mock: an object that replaces the actual object (and that object's API)
   - fake: a lightweight object that does not reach production level

#### Integration Testing

A test that integrates the input and output of multiple functions or methods requires combining multiple test objects.

 - Test component interoperability / Requirements change testing / External dependencies and APIs / Debug hardware issues / Find exceptions in code paths


#### System test

Testing of requirements, testing whether the finished product finally meets all requirements, is performed when the customer accepts the project.

#### Data Driven Testing

Use external data sources to parameterize input and expected values ​​and avoid hard-coded data in tests.

The function under test:

````Python
def add(x, y):
    return x + y
````

data.csv file:

````
3,1,2
0,1,-1
100,50,50
100,1,99
15,7,8
````

Test code:

````Python
import csv

from unittest import TestCase
from ddt import ddt, data, unpack


@ddt
class TestAdd(TestCase):

    def load_data_from_csv(filename):
        data_items = []
        with open(filename, 'r', newline='') as fs:
            reader = csv.reader(fs)
            for row in reader:
                data_items.append(list(map(int, row)))
        return data_items


    @data(*load_data_from_csv('data.csv'))
    @unpack
    def test_add(self, result, param1, param2):
        self.assertEqual(result, add(param1, param2))
````

#### Testing in Django

1. Test Django views - `TestCase` provided in Django extends `TestCase` in `unittest` and binds an attribute named `client`, which can be used to simulate GET, POST, DELETE, PUT and other requests.


````Python
class SomeViewTest(TestCase):

    def test_example_view(self):
        resp = self.client.get(reverse('index'))
        self.assertEqual(200, resp.status_code)
        self.assertEqual(5, resp.context['num'])
````

2. Run the test - configure the test database.

````Python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'HOST': 'localhost',
        'PORT': 3306,
        'NAME': 'DbName',
        'USER': os.environ['DB_USER'],
        'PASSWORD': os.environ['DB_PASS'],
        'TEST': {
            'NAME': 'DbName_for_testing',
            'CHARSET': 'utf8',
        },
    }
}
````

```Shell
python manage.py test
python manage.py test common
python manage.py test common.tests.UtilsTest
python manage.py test common.tests.UtilsTest.test_to_md5_hex
````

3. Assess test coverage

```Shell
pip install coverage
coverage run --source=<path1> --omit=<path2> manage.py test common
coverage report

Name Stmts Miss Cover
-------------------------------------------------- -
common/__init__.py 0 0 100%
common/admin.py 1 0 100%
common/apps.py 3 3 0%
common/forms.py 16 16 0%
common/helper.py 32 32 0%
common/middlewares.py 19 19 0%
common/migrations/__init__.py 0 0 100%
common/models.py 71 2 97%
common/serializers.py 14 14 0%
common/tests.py 14 8 43%
common/urls_api.py 3 3 0%
common/urls_user.py 3 3 0%
common/utils.py 22 7 68%
common/views.py 69 69 0%
-------------------------------------------------- -
TOTAL 267 176 34%
````

#### Performance Testing

Question 1: What are the indicators of performance testing?

1. ab (Apache Benchmark)/webbench/httpperf

   ```Shell
   yum -y install httpd
   ab -c 10 -n 1000 http://www.baidu.com/
   ...
   Benchmarking www.baidu.com (be patient).....done
   Server Software: BWS/1.1
   Server Hostname: www.baidu.com
   Server Port: 80
   Document Path: /
   Document Length: 118005 bytes
   Concurrency Level: 10
   Time taken for tests: 0.397 seconds
   Complete requests: 100
   Failed requests: 98
      (Connect: 0, Receive: 0, Length: 98, Exceptions: 0)
   Write errors: 0
   Total transferred: 11918306 bytes
   HTML transferred: 11823480 bytes
   Requests per second: 252.05 [#/sec] (mean)
   Time per request: 39.675 [ms] (mean)
   Time per request: 3.967 [ms] (mean, across all concurrent requests)
   Transfer rate: 29335.93 [Kbytes/sec] received
   Connection Times (ms)
                 min mean[+/-sd] median max
   Connect: 6 7 0.6 7 9
   Processing: 20 27 22.7 24 250
   Waiting: 8 11 21.7 9 226
   Total: 26 34 22.8 32 258
   Percentage of the requests served within a certain time (ms)
     50% 32
     66% 34
     75% 34
     80% 34
     90% 36
     95% 39
     98% 51
     99% 258
    100% 258 (longest request)
   ````

2. mysqlslap

   ```Shell
   mysqlslap -a -c 100 -h 1.2.3.4 -u root -p
   mysqlslap -a -c 100 --number-of-queries=1000 --auto-generate-sql-load-type=read -h <IP address of load balancing server> -u root -p
   mysqlslap -a --concurrency=50,100 --number-of-queries=1000 --debug-info --auto-generate-sql-load-type=mixed -h 1.2.3.4 -u root -p
   ````

3. sysbench

   ```Shell
   sysbench --test=threads --num-threads=64 --thread-yields=100 --thread-locks=2 run
   sysbench --test=memory --num-threads=512 --memory-block-size=256M --memory-total-size=32G run
   ````

4. JMeter

   Please check ["Performance Testing with JMeter"](https://www.ibm.com/developerworks/cn/java/l-jmeter/index.html).

5. LoadRunner/QTP

### Project debugging

You can use django-debug-toolbar to assist project debugging.

1. Installation

   ```Shell
   pip install django-debug-toolbar
   ````

2. Configuration - Modify settings.py.

   ````Python
   INSTALLED_APPS = [
       'debug_toolbar',
   ]
   
   MIDDLEWARE = ​​[
       'debug_toolbar.middleware.DebugToolbarMiddleware',
   ]
   
   DEBUG_TOOLBAR_CONFIG = {
       # Import jQuery library
       'JQUERY_URL': 'https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js',
       # Whether the toolbar is collapsed
       'SHOW_COLLAPSED': True,
       # Whether to show the toolbar
       'SHOW_TOOLBAR_CALLBACK': lambda x: True,
   }
   ````

3. Configuration - Modify urls.py.

   ````Python
   if settings.DEBUG:
   
       import debug_toolbar
   
       urlpatterns.insert(0, path('__debug__/', include(debug_toolbar.urls)))
   ````

4. Use - You can see a debugging toolbar on the right side of the page, which includes debugging information such as execution time, project settings, request headers, SQL, static resources, templates, caches, signals, etc. It is very convenient to view.

5. Before the project goes live, please remember to **remove all configurations related to django-debug-toolbar**.

### Deployment related

Please refer to ["Project Deployment Online and Performance Tuning"] (98. Project Deployment Online and Performance Tuning.md).

### Performance related

#### Two laws of website optimization:

1. Use cache as much as possible - sacrifice space for time (universal strategy).

2. Postpone everything that can be postponed - Use message queues to serialize parallel tasks to relieve server pressure.

   - Instantaneous spikes in server CPU utilization - Peak shaving (a flat increase in CPU utilization)
   - Decoupling of upstream and downstream nodes (the systems for placing orders and accepting orders are usually separated)


#### Django framework

1. Configure the cache to relieve the pressure on the database, and have a reasonable mechanism to deal with [cache penetration and cache avalanche](https://www.cnblogs.com/zhangweizhong/p/6258797.html).

2. Enable [Template Cache](https://docs.djangoproject.com/en/2.0/ref/templates/api/#django.template.loaders.cached.Loader) to speed up template rendering.

   ````Python
   TEMPLATES = [
       {
           'BACKEND': 'django.template.backends.django.DjangoTemplates',
           'DIRS': [os.path.join(BASE_DIR, 'templates'), ],
           # 'APP_DIRS': True,
           'OPTIONS': {
               'context_processors': [
                   'django.template.context_processors.debug',
                   'django.template.context_processors.request',
                   'django.contrib.auth.context_processors.auth',
                   'django.contrib.messages.context_processors.messages',
               ],
               'loaders': [(
                   'django.template.loaders.cached.Loader', [
                       'django.template.loaders.filesystem.Loader',
                       'django.template.loaders.app_directories.Loader',
                   ], ),
               ],
           },
       },
   ]
   ````

3. Relieve memory pressure with lazy evaluation, iterators, `defer()`, `only()`, etc.

4. Use `select_related()` and `prefetch_related()` to perform preloading to avoid the "1+N query problem".

#### database

1. Replace the auto-incrementing primary key with an ID generator (better performance, suitable for distributed environments).

   - Custom ID generator - snowflake

   - UUID

   ````Python
   >>> my_uuid = uuid.uuid1()
   >>> my_uuid
   UUID('63f859d0-a03a-11e8-b0ad-60f81da8d840')
   >>> my_uuid.hex
   '63f859d0a03a11e8b0ad60f81da8d840'
   ````

2. Avoid unnecessary constraints on foreign key columns (unless referential integrity must be guaranteed), and do not use mechanisms such as triggers.

3. Use indexes to optimize query performance (indexes are placed on the fields to be used for queries). InnoDB uses BTREE indexes, which can be used when using >, <, >=, <=, BETWEEN, or LIKE 'pattern' (pattern does not start with a wildcard). Because creating an index requires additional disk space, and there is a default index on the primary key, you should choose a shorter data type for the primary key to reduce disk usage and improve the caching effect of the index.

   ````SQL
   create index idx_goods_name on tb_goods (gname(10));
   ````

   ````SQL
   -- can't use index
   select * from tb_goods where gname like '%iPhone%';
   -- can use index
   select * from tb_goods where gname like 'iPhone%';
   ````

   ````Python
   # can't use index
   Goods.objects.filter(name_icontains='iPhone')
   # can use index
   Goods.objects.filter(name__istartswith='iPhone');
   ````

4. Use a stored procedure (a set of SQL statements compiled on the server side).

   ````SQL
   drop procedure if exists sp_avg_sal_by_dept;
   
   create procedure sp_avg_sal_by_dept(deptno integer, out avg_sal float)
   begin
       select avg(sal) into avg_sal from TbEmp where dno=deptno;
   end;
   
   call sp_avg_sal_by_dept(10, @a);
   
   select @a;
   ````

   ````Python
   >>> from django.db import connection
   >>> cursor = connection.cursor()
   >>> cursor.callproc('sp_avg_sal_by_dept', (10, 0))
   >>> cursor.execute('select @_sp_avg_sal_by_dept_1')
   >>> cursor.fetchone()
   (2675.0,)
   ````

5. Use data partitions. Partitioning can store more data, optimize query throughput for greater throughput, and quickly delete expired data. For this knowledge point, you can look at MySQL's [official document] (https://dev.mysql.com/doc/refman/5.7/en/partitioning-overview.html).

   - RANGE partition: Based on the continuous interval range, the data is allocated to different partitions.
   - LIST partition: Based on the range of enumeration values, the data is allocated to different partitions.
   - HASH partition / KEY partition: Based on the number of partitions, data is allocated to different partitions.

   ```SQL
   CREATE TABLE tb_emp (
       eno INT NOT NULL,
       ename VARCHAR(20) NOT NULL,
       job VARCHAR(10) NOT NULL,
       hiredate DATE NOT NULL,
       dno INT NOT NULL
   )
   PARTITION BY HASH(dno)
   PARTITIONS 4;
   ```

   ```SQL
   CREATE TABLE tb_emp (
       eno INT NOT NULL,
       ename VARCHAR(20) NOT NULL,
       job VARCHAR(10) NOT NULL,
       hiredate DATE NOT NULL,
       dno INT NOT NULL
   )
   PARTITION BY RANGE( YEAR(hiredate) ) (
       PARTITION p0 VALUES LESS THAN (1960),
       PARTITION p1 VALUES LESS THAN (1970),
       PARTITION p2 VALUES LESS THAN (1980),
       PARTITION p3 VALUES LESS THAN (1990),
       PARTITION p4 VALUES LESS THAN MAXVALUE
   );
   ```

6. Use `explain` to analyze query performance - execution plan.

   ````SQL
   explain select * from ...;
   ````

   `explain` result parsing:

   - select_type: Indicates the type of select operation. Common values ​​are SIMPLE (simple query, no sub query or table join query), PRIMARY (main query, outer query), UNION (the second in the union operation or subsequent queries), SUBQUERY (the first SELECT in a subquery), etc.
   - table: The table to output the results.
   - type: The way MySQL finds the desired row in the table, also known as the access type, common values ​​are:
     - ALL: full table scan (traverse the entire table to find matching rows)
     - index: index full scan (traverse the entire index)
     - range: index range scan
     - ref: a non-unique index scan or a prefix scan of a unique index
     - eq_ref: unique index scan
     - const/system: at most one row in the table matches
     - NULL: no access to the table or index
   - possible_keys: Indexes that may be used when querying.
   - key: The actual index used.
   - key_len: The length of the index field used.
   - rows: The number of scanned rows.
   - Extra: Extra information (an explanation or description of the implementation).

   > Note: For more knowledge about MySQL, especially performance tuning and operation and maintenance, it is recommended that you read the "In-depth MySQL (Second Edition)" produced by NetEase, which must be a high-quality product.

7. Use the slow query log to spot low-performing queries.

   ````SQL
   mysql> show variables like 'slow_query%';
   +--------------------------+--------------------- -------------+
   | Variable_name | Value |
   +--------------------------+--------------------- -------------+
   | slow_query_log | OFF |
   | slow_query_log_file | /mysql/data/localhost-slow.log |
   +--------------------------+--------------------- -------------+
   
   mysql> show variables like 'long_query_time';
   +-----+------------+
   | Variable_name | Value |
   +-----+------------+
   | long_query_time | 10.000000 |
   +-----+------------+
   ````

   ````SQL
   mysql> set global slow_query_log='ON';
   mysql> set global long_query_time=1;
   ````

   ````INI
   [mysqld]
   slow_query_log=ON
   slow_query_log_file=/usr/local/mysql/data/slow.log
   long_query_time=1
   ````